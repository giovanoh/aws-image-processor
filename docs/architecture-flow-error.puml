@startuml Image Processor - Error and Retry Flow
!theme cerulean-outline
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam backgroundColor White
skinparam actor {
  FontColor Black
}
skinparam participant {
  FontColor Black
}
skinparam queue {
  FontColor Black
}

title Error Flow: Retry and Dead Letter Queue
 
actor "User" as User
participant "S3\n(image-processor-in)" as S3Input #LightBlue
queue "SQS\n(product-image-queue)" as SQS #Orange
participant "Lambda\n(ProcessImageFunction)" as Lambda #Green
participant "S3\n(image-processor-out)" as S3Output #LightBlue
queue "DLQ\n(product-image-queue-dlq)" as DLQ #Red
participant "CloudWatch\nLogs" as CW #Purple

== 1. First Attempt (Failure) ==

SQS -> Lambda: Poll message (attempt 1/3)
activate Lambda

Lambda -> S3Input: GetObject(corrupted-photo.jpg)
activate S3Input
S3Input --> Lambda: Return image
deactivate S3Input

Lambda -> Lambda: Try to decode image
note right of Lambda #Pink
  Error: corrupted image
  image.Decode() fails
end note

Lambda -> CW: log.Printf("Error decoding")
activate CW
CW --> Lambda: OK
deactivate CW

Lambda --> SQS: return error
deactivate Lambda

note right of SQS
  SQS receives error and:
  1. Does NOT delete message
  2. Message becomes invisible for 5min
  3. Increments receive count
end note

SQS -> SQS: ChangeMessageVisibility(300s)

== 2. Second Attempt (Failure) ==

note over SQS
  After 5 minutes,
  message becomes visible again
end note

SQS -> Lambda: Poll message (attempt 2/3)
activate Lambda

Lambda -> S3Input: GetObject(corrupted-photo.jpg)
activate S3Input
S3Input --> Lambda: Return image
deactivate S3Input

Lambda -> Lambda: Try to decode image
note right of Lambda #Pink
  Same error
end note

Lambda -> CW: log.Printf("Error decoding")
activate CW
CW --> Lambda: OK
deactivate CW

Lambda --> SQS: return error
deactivate Lambda

SQS -> SQS: Receive count = 2

== 3. Third Attempt (Failure) ==

note over SQS #Yellow
  Last attempt before DLQ
end note

SQS -> Lambda: Poll message (attempt 3/3)
activate Lambda

Lambda -> S3Input: GetObject(corrupted-photo.jpg)
activate S3Input
S3Input --> Lambda: Return image
deactivate S3Input

Lambda -> Lambda: Try to decode image
note right of Lambda #Pink
  Fails again
end note

Lambda -> CW: log.Printf("Error decoding")
activate CW
CW --> Lambda: OK
deactivate CW

Lambda --> SQS: return error
deactivate Lambda

SQS -> SQS: Receive count = 3 (maximum)

== 4. Send to Dead Letter Queue ==

note right of SQS #Red
  maxReceiveCount reached!
  Message goes to DLQ
end note

SQS -> DLQ: SendMessage(original message)
activate DLQ

note right of DLQ
  Message stays in DLQ
  for manual analysis
  
  Developers can:
  - Investigate the issue
  - Fix image
  - Reprocess manually
end note

SQS -> SQS: DeleteMessage()
deactivate DLQ

== 5. Alert (Optional) ==

DLQ -> CW: Metric: NumberOfMessagesSent
activate CW

note over CW #Orange
  CloudWatch Alarm can
  notify via SNS/Email
  when DLQ receives messages
end note

CW --> DLQ: OK
deactivate CW

note over User, CW #Pink
  **PROCESSING FAILED**
  
  Required actions:
  1. Check logs in CloudWatch
  2. Investigate messages in DLQ
  3. Fix the problem
  4. Reprocess manually if necessary
end note

@enduml
